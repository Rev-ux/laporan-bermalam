<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rekap Karyawan Bermalam Bulanan</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f6f9; padding: 20px; max-width: 1200px; margin: auto; }
        h1, h2 { color: #333; text-align: center; }
        form { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 30px; }
        label { display: block; margin: 15px 0 5px; font-weight: bold; color: #444; }
        input, select { padding: 12px; width: 100%; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; }
        button { background: #28a745; color: white; padding: 12px 20px; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; margin-top: 10px; }
        button:hover { background: #218838; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #007bff; color: white; }
        tr:hover { background: #f8f9fa; }
        .search-input, .filter-select { margin: 15px 0; padding: 10px; width: 100%; }
        .export-btn { background: #ffc107; color: #333; margin: 10px 0; }
        .export-btn:hover { background: #e0a800; }
        #chartContainer { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-top: 30px; }
        .total-summary { font-weight: bold; font-size: 1.2em; text-align: right; margin: 20px 0; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>Rekap Karyawan Bermalam</h1>

    <form id="laporanForm">
        <label>Nama Karyawan</label>
        <select id="nama" required></select>
        <input type="text" id="namaBaru" placeholder="Ketik nama baru jika belum ada" style="margin-top:5px;">

        <label>Cabang</label>
        <select id="cabang" required>
            <option value="Twincom Banjarbaru">Twincom Banjarbaru</option>
            <option value="Twincom Martapura">Twincom Martapura</option>
            <option value="Twincom A. Yani">Twincom A. Yani</option>
            <option value="Pandacom Banjarbaru">Pandacom Banjarbaru</option>
        </select>

        <label>Tanggal Bermalam</label>
        <input type="date" id="tanggal" required>

        <label>Biaya per Malam (Rp)</label>
        <input type="number" id="biaya" value="30000" required min="0">

        <button type="submit">Tambah Laporan</button>
    </form>

    <h2>Daftar Laporan Lengkap</h2>
    <input type="text" id="searchInput" class="search-input" placeholder="Cari nama atau cabang...">
    <table id="tabelLaporan">
        <thead>
            <tr>
                <th>No</th>
                <th>Waktu Input</th>
                <th>Tanggal Bermalam</th>
                <th>Nama Karyawan</th>
                <th>Cabang</th>
                <th>Biaya (Rp)</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <h2>Rekap Bulanan (mirip Excel)</h2>
    <select id="bulanRekap" class="filter-select" onchange="updateRekap()"></select>

    <table id="tabelRekap">
        <thead>
            <tr>
                <th>NO</th>
                <th>NAMA KARYAWAN</th>
                <th>TANGGAL BERMALAM</th>
                <th>CABANG DIINAPI</th>
                <th>TOTAL BERMALAM</th>
                <th>JUMLAH UANG BERMALAM</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div class="total-summary" id="totalSummary"></div>
    <button class="export-btn" onclick="exportRekapCSV()">Export Rekap Bulanan ke CSV</button>

    <div id="chartContainer">
        <canvas id="rekapChart"></canvas>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // === GANTI DENGAN CONFIG FIREBASE ANDA ===
const firebaseConfig = {
  apiKey: "AIzaSyBthcmgxb-S7AOqhQEkRl4gA2tGtc373DE",
  authDomain: "laporan-bermalam.firebaseapp.com",
  databaseURL: "https://laporan-bermalam-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "laporan-bermalam",
  storageBucket: "laporan-bermalam.firebasestorage.app",
  messagingSenderId: "999268337318",
  appId: "1:999268337318:web:ca06ca521b49347bce9667",
  measurementId: "G-NPZ94WSPXX"
};
        // =========================================

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const refLaporan = db.ref('laporan');

        const form = document.getElementById('laporanForm');
        const namaSelect = document.getElementById('nama');
        const namaBaru = document.getElementById('namaBaru');
        const tabelBody = document.querySelector('#tabelLaporan tbody');
        const rekapBody = document.querySelector('#tabelRekap tbody');
        const bulanRekap = document.getElementById('bulanRekap');
        const totalSummary = document.getElementById('totalSummary');
        const searchInput = document.getElementById('searchInput');
        let allData = [];
        let karyawanList = [];
        let chart;

        // Set tanggal default hari ini
        document.getElementById('tanggal').valueAsDate = new Date();

        // Update dropdown nama karyawan
        function updateNamaDropdown() {
            namaSelect.innerHTML = '<option value="">Pilih karyawan existing</option>';
            karyawanList.sort().forEach(k => {
                namaSelect.innerHTML += `<option value="\( {k}"> \){k}</option>`;
            });
        }

        // Tambah laporan
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            let nama = namaSelect.value.trim();
            if (!nama && namaBaru.value.trim()) {
                nama = namaBaru.value.trim().toUpperCase();
                if (!karyawanList.includes(nama)) {
                    karyawanList.push(nama);
                    updateNamaDropdown();
                }
            }
            if (!nama) { alert('Masukkan nama karyawan!'); return; }

            const cabang = document.getElementById('cabang').value;
            const tanggal = document.getElementById('tanggal').value;
            const biaya = parseInt(document.getElementById('biaya').value);

            refLaporan.push({
                nama,
                cabang,
                tanggal,
                biaya,
                timestamp: Date.now()
            });

            form.reset();
            document.getElementById('tanggal').valueAsDate = new Date();
            namaBaru.value = '';
        });

        // Load data real-time
        refLaporan.on('value', (snapshot) => {
            allData = [];
            karyawanList = [];
            const data = snapshot.val();
            if (data) {
                Object.values(data).forEach(val => {
                    allData.push(val);
                    if (!karyawanList.includes(val.nama)) karyawanList.push(val.nama);
                });
            }
            renderLaporan();
            updateBulanFilter();
            updateRekap();
            updateNamaDropdown();
        });

        function renderLaporan() {
            tabelBody.innerHTML = '';
            allData.sort((a,b) => b.timestamp - a.timestamp).forEach((val, i) => {
                const waktu = new Date(val.timestamp).toLocaleString('id-ID');
                tabelBody.innerHTML += `
                    <tr>
                        <td>${i+1}</td>
                        <td>${waktu}</td>
                        <td>${val.tanggal}</td>
                        <td>${val.nama}</td>
                        <td>${val.cabang}</td>
                        <td>Rp ${val.biaya.toLocaleString('id-ID')}</td>
                    </tr>
                `;
            });
        }

        // Filter bulan rekap
        function updateBulanFilter() {
            const bulanSet = new Set();
            allData.forEach(d => {
                const date = new Date(d.tanggal);
                const key = `\( {date.getFullYear()}- \){String(date.getMonth()+1).padStart(2,'0')}`;
                bulanSet.add(key);
            });
            bulanRekap.innerHTML = '<option value="">Pilih Bulan</option>';
            Array.from(bulanSet).sort().reverse().forEach(key => {
                const [y, m] = key.split('-');
                const namaBulan = new Date(y, m-1).toLocaleString('id-ID', {month:'long', year:'numeric'});
                bulanRekap.innerHTML += `<option value="\( {key}"> \){namaBulan}</option>`;
            });
            if (bulanRekap.options.length > 1) bulanRekap.selectedIndex = 1; // default bulan terbaru
        }

        // Update rekap bulanan
        function updateRekap() {
            const filter = bulanRekap.value;
            if (!filter) {
                rekapBody.innerHTML = '<tr><td colspan="6">Pilih bulan untuk melihat rekap</td></tr>';
                totalSummary.textContent = '';
                return;
            }

            const [tahun, bulan] = filter.split('-').map(Number);
            const filtered = allData.filter(d => {
                const date = new Date(d.tanggal);
                return date.getFullYear() === tahun && (date.getMonth()+1) === bulan;
            });

            // Group per karyawan
            const group = {};
            filtered.forEach(d => {
                if (!group[d.nama]) group[d.nama] = {tanggal:[], cabang:new Set(), total:0, uang:0};
                group[d.nama].tanggal.push(d.tanggal.split('-')[2]); // hari saja
                group[d.nama].cabang.add(d.cabang);
                group[d.nama].total += 1;
                group[d.nama].uang += d.biaya;
            });

            // Sort by total descending
            const sorted = Object.entries(group).sort((a,b) => b[1].total - a[1].total);

            rekapBody.innerHTML = '';
            let grandTotalMalam = 0;
            let grandTotalUang = 0;
            sorted.forEach(([nama, info], idx) => {
                const tanggalStr = info.tanggal.sort((a,b)=>a-b).join(', ') + ' ' + new Date(tahun, bulan-1).toLocaleString('id-ID', {month:'long', year:'numeric'}).split(' ')[2]; // tambah bulan tahun di akhir
                const cabangStr = Array.from(info.cabang).join(', ');
                rekapBody.innerHTML += `
                    <tr>
                        <td>${idx+1}</td>
                        <td>${nama}</td>
                        <td>${tanggalStr}</td>
                        <td>${cabangStr}</td>
                        <td>${info.total} x</td>
                        <td>Rp ${info.uang.toLocaleString('id-ID')}</td>
                    </tr>
                `;
                grandTotalMalam += info.total;
                grandTotalUang += info.uang;
            });

            totalSummary.textContent = `Total Bermalam Semua Karyawan: ${grandTotalMalam} malam | Total Uang Bermalam: Rp ${grandTotalUang.toLocaleString('id-ID')}`;
            updateChart(sorted);
        }

        // Chart per karyawan
        function updateChart(sortedData) {
            if (chart) chart.destroy();
            const labels = sortedData.map(([nama]) => nama);
            const data = sortedData.map(([,info]) => info.total);
            chart = new Chart(document.getElementById('rekapChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{ label: 'Total Malam Bermalam', data: data, backgroundColor: '#28a745' }]
                },
                options: { scales: { y: { beginAtZero: true } } }
            });
        }

        // Export rekap ke CSV
        function exportRekapCSV() {
            if (!bulanRekap.value) { alert('Pilih bulan dulu!'); return; }
            updateRekap(); // pastikan data terbaru
            let csv = "NO,NAMA KARYAWAN,TANGGAL BERMALAM,CABANG DIINAPI,TOTAL BERMALAM,JUMLAH UANG BERMALAM\n";
            document.querySelectorAll('#tabelRekap tbody tr').forEach((row, i) => {
                const cells = row.querySelectorAll('td');
                csv += `\( {i+1}, \){cells[1].textContent},\( {cells[2].textContent}, \){cells[3].textContent},\( {cells[4].textContent}, \){cells[5].textContent}\n`;
            });
            const blob = new Blob([csv], {type: 'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Rekap_Bermalam_${bulanRekap.selectedOptions[0].text}.csv`;
            a.click();
        }

        // Search di tabel laporan
        searchInput.addEventListener('input', () => {
            const filter = searchInput.value.toLowerCase();
            document.querySelectorAll('#tabelLaporan tbody tr').forEach(row => {
                row.style.display = row.textContent.toLowerCase().includes(filter) ? '' : 'none';
            });
        });
    </script>
</body>
</html>
