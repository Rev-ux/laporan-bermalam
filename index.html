<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rekap Karyawan Bermalam</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f6f9; padding: 20px; max-width: 1200px; margin: auto; }
        h1 { text-align: center; color: #333; }
        .tabs { overflow: hidden; border-bottom: 2px solid #007bff; margin-bottom: 30px; }
        .tablink { background: #f1f1f1; float: left; border: none; outline: none; cursor: pointer; padding: 14px 20px; font-size: 17px; width: 50%; }
        .tablink:hover { background: #ddd; }
        .tablink.active { background: #007bff; color: white; }
        .tabcontent { display: none; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); animation: fadeIn 0.5s; }
        @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
        form { padding: 25px; margin-bottom: 30px; }
        label { display: block; margin: 15px 0 5px; font-weight: bold; color: #444; }
        input, select { padding: 12px; width: 100%; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; box-sizing: border-box; }
        button { background: #28a745; color: white; padding: 12px 20px; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; }
        button:hover { background: #218838; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #007bff; color: white; }
        tr:hover { background: #f8f9fa; }
        .search-input { margin: 15px 0; padding: 10px; width: 100%; }
        .export-btn { background: #ffc107; color: #333; margin: 20px 0; padding: 12px; width: 100%; font-size: 16px; }
        .export-btn:hover { background: #e0a800; }
        .total-summary { font-weight: bold; font-size: 1.3em; text-align: right; margin: 30px 0; background: #e9ecef; padding: 20px; border-radius: 8px; }
        .filter-select { padding: 12px; margin-bottom: 20px; width: 100%; font-size: 16px; }
        #alasanContainer { display: none; margin-top: 15px; }
    </style>
</head>
<body>
    <h1>Rekap Karyawan Bermalam</h1>

    <div class="tabs">
        <button class="tablink active" onclick="openTab(event, 'Input')">Input Laporan</button>
        <button class="tablink" onclick="openTab(event, 'Rekap')">Rekap Bulanan</button>
    </div>

    <!-- TAB INPUT LAPORAN -->
    <div id="Input" class="tabcontent" style="display: block;">
        <form id="laporanForm">
            <label>Nama Karyawan</label>
            <input type="text" id="nama" required placeholder="Masukkan nama karyawan">

            <label>Cabang Diinapi</label>
            <select id="cabang" required>
                <option value="Twincom Banjarbaru">Twincom Banjarbaru</option>
                <option value="Twincom Martapura">Twincom Martapura</option>
                <option value="Twincom A. Yani">Twincom A. Yani</option>
                <option value="Pandacom Banjarbaru">Pandacom Banjarbaru</option>
            </select>

            <label>Tanggal Bermalam</label>
            <input type="date" id="tanggal" required>

            <label>Jam Datang</label>
            <input type="time" id="jamDatang" required>

            <div id="alasanContainer">
                <label>Alasan Telat (wajib jika datang > 22:30)</label>
                <input type="text" id="alasanTelat" placeholder="Tuliskan alasan keterlambatan">
            </div>

            <button type="submit">Tambah Laporan</button>
        </form>

        <h2>Daftar Laporan Terbaru</h2>
        <input type="text" id="searchInput" class="search-input" placeholder="Cari nama, cabang, atau alasan...">
        <table id="tabelLaporan">
            <thead>
                <tr>
                    <th>No</th>
                    <th>Waktu Input</th>
                    <th>Tanggal</th>
                    <th>Jam Datang</th>
                    <th>Nama</th>
                    <th>Cabang</th>
                    <th>Alasan Telat</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- TAB REKAP BULANAN -->
    <div id="Rekap" class="tabcontent">
        <h2>Rekap Karyawan Bermalam Bulanan</h2>
        <select id="bulanRekap" class="filter-select" onchange="updateRekap()"></select>

        <table id="tabelRekap">
            <thead>
                <tr>
                    <th>NO</th>
                    <th>NAMA KARYAWAN</th>
                    <th>TANGGAL BERMALAM</th>
                    <th>CABANG DIINAPI</th>
                    <th>TOTAL BERMALAM</th>
                    <th>JUMLAH UANG BERMALAM</th>
                    <th>ALASAN TELAT</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div class="total-summary" id="totalSummary"></div>
        <button class="export-btn" onclick="exportRekapCSV()">Export Rekap ke CSV (Excel)</button>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // === GANTI DENGAN CONFIG FIREBASE ANDA ===
const firebaseConfig = {
  apiKey: "AIzaSyBthcmgxb-S7AOqhQEkRl4gA2tGtc373DE",
  authDomain: "laporan-bermalam.firebaseapp.com",
  databaseURL: "https://laporan-bermalam-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "laporan-bermalam",
  storageBucket: "laporan-bermalam.firebasestorage.app",
  messagingSenderId: "999268337318",
  appId: "1:999268337318:web:ca06ca521b49347bce9667",
  measurementId: "G-NPZ94WSPXX"
};
        // =========================================

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const refLaporan = db.ref('laporan');

        const form = document.getElementById('laporanForm');
        const jamDatang = document.getElementById('jamDatang');
        const alasanContainer = document.getElementById('alasanContainer');
        const alasanTelat = document.getElementById('alasanTelat');
        const tabelBody = document.querySelector('#tabelLaporan tbody');
        const rekapBody = document.querySelector('#tabelRekap tbody');
        const bulanRekap = document.getElementById('bulanRekap');
        const totalSummary = document.getElementById('totalSummary');
        const searchInput = document.getElementById('searchInput');
        let allData = [];

        // Set tanggal default hari ini
        document.getElementById('tanggal').valueAsDate = new Date();

        // Cek jam datang > 22:30 â†’ tampilkan alasan
        jamDatang.addEventListener('change', () => {
            const jam = jamDatang.value;
            if (jam > '22:30') {
                alasanContainer.style.display = 'block';
                alasanTelat.required = true;
            } else {
                alasanContainer.style.display = 'none';
                alasanTelat.required = false;
                alasanTelat.value = '';
            }
        });

        // Tab navigation (diperbaiki)
        function openTab(evt, tabName) {
            const tabcontent = document.getElementsByClassName("tabcontent");
            for (let i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            const tablinks = document.getElementsByClassName("tablink");
            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";

            if (tabName === 'Rekap') {
                updateRekap();
            }
        }

        // Tambah laporan
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const nama = document.getElementById('nama').value.trim().toUpperCase();
            const cabang = document.getElementById('cabang').value;
            const tanggal = document.getElementById('tanggal').value;
            const jam = jamDatang.value;
            const alasan = jam > '22:30' ? alasanTelat.value.trim() : '';

            if (nama && cabang && tanggal && jam) {
                if (jam > '22:30' && !alasan) {
                    alert('Alasan telat wajib diisi jika datang setelah jam 22:30!');
                    return;
                }

                refLaporan.push({
                    nama,
                    cabang,
                    tanggal,
                    jamDatang: jam,
                    alasanTelat: alasan,
                    timestamp: Date.now()
                });

                form.reset();
                document.getElementById('tanggal').valueAsDate = new Date();
                alasanContainer.style.display = 'none';
            }
        });

        // Load data real-time
        refLaporan.on('value', (snapshot) => {
            allData = [];
            const data = snapshot.val();
            if (data) {
                Object.values(data).forEach(val => allData.push(val));
            }
            renderLaporan();
            updateBulanFilter();
            if (document.getElementById('Rekap').style.display === 'block') {
                updateRekap();
            }
        });

        function renderLaporan() {
            tabelBody.innerHTML = '';
            allData.sort((a,b) => b.timestamp - a.timestamp).forEach((val, i) => {
                const waktu = new Date(val.timestamp).toLocaleString('id-ID');
                tabelBody.innerHTML += `
                    <tr>
                        <td>${i+1}</td>
                        <td>${waktu}</td>
                        <td>${val.tanggal}</td>
                        <td>${val.jamDatang}</td>
                        <td>${val.nama}</td>
                        <td>${val.cabang}</td>
                        <td>${val.alasanTelat || '-'}</td>
                    </tr>
                `;
            });
        }

        // Update filter bulan
        function updateBulanFilter() {
            const bulanSet = new Set();
            allData.forEach(d => {
                const date = new Date(d.tanggal);
                const key = `\( {date.getFullYear()}- \){String(date.getMonth()+1).padStart(2,'0')}`;
                bulanSet.add(key);
            });
            bulanRekap.innerHTML = '<option value="">Pilih Bulan Rekap</option>';
            Array.from(bulanSet).sort().reverse().forEach(key => {
                const [y, m] = key.split('-');
                const namaBulan = new Date(y, m-1).toLocaleString('id-ID', {month:'long', year:'numeric'});
                bulanRekap.innerHTML += `<option value="\( {key}"> \){namaBulan}</option>`;
            });
            if (bulanRekap.options.length > 1) bulanRekap.selectedIndex = 1;
        }

        // Update rekap bulanan
        function updateRekap() {
            const filter = bulanRekap.value;
            if (!filter) {
                rekapBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Pilih bulan untuk melihat rekap</td></tr>';
                totalSummary.textContent = '';
                return;
            }

            const [tahun, bulan] = filter.split('-').map(Number);
            const filtered = allData.filter(d => {
                const date = new Date(d.tanggal);
                return date.getFullYear() === tahun && (date.getMonth()+1) === bulan;
            });

            const group = {};
            filtered.forEach(d => {
                if (!group[d.nama]) group[d.nama] = {
                    tanggal: [],
                    cabang: new Set(),
                    total: 0,
                    alasan: []
                };
                const hari = d.tanggal.split('-')[2];
                group[d.nama].tanggal.push(hari);
                group[d.nama].cabang.add(d.cabang);
                group[d.nama].total += 1;
                if (d.alasanTelat) group[d.nama].alasan.push(`${hari}: ${d.alasanTelat}`);
            });

            const sorted = Object.entries(group).sort((a,b) => b[1].total - a[1].total);

            rekapBody.innerHTML = '';
            let grandTotalMalam = 0;
            let grandTotalUang = 0;
            const BIAYA_PER_MALAM = 30000;

            sorted.forEach(([nama, info], idx) => {
                const tanggalStr = info.tanggal.sort((a,b)=>a-b).join(', ') + ` ${new Date(tahun, bulan-1).toLocaleString('id-ID', {month:'long', year:'numeric'}).split(' ')[1]} ${tahun}`;
                const cabangStr = Array.from(info.cabang).join(', ');
                const uang = info.total * BIAYA_PER_MALAM;
                const alasanStr = info.alasan.length > 0 ? info.alasan.join('; ') : '-';

                rekapBody.innerHTML += `
                    <tr>
                        <td>${idx+1}</td>
                        <td>${nama}</td>
                        <td>${tanggalStr}</td>
                        <td>${cabangStr}</td>
                        <td>${info.total} x</td>
                        <td>Rp ${uang.toLocaleString('id-ID')}</td>
                        <td>${alasanStr}</td>
                    </tr>
                `;
                grandTotalMalam += info.total;
                grandTotalUang += uang;
            });

            totalSummary.textContent = `Total Bermalam: ${grandTotalMalam} malam | Total Uang Bermalam: Rp ${grandTotalUang.toLocaleString('id-ID')}`;
        }

        // Export rekap ke CSV
        function exportRekapCSV() {
            if (!bulanRekap.value) { alert('Pilih bulan dulu!'); return; }
            let csv = "NO,NAMA KARYAWAN,TANGGAL BERMALAM,CABANG DIINAPI,TOTAL BERMALAM,JUMLAH UANG BERMALAM,ALASAN TELAT\n";
            document.querySelectorAll('#tabelRekap tbody tr').forEach((row, i) => {
                const cells = row.querySelectorAll('td');
                if (cells.length === 7) {
                    csv += `\( {i+1}, \){cells[1].textContent},"\( {cells[2].textContent}", \){cells[3].textContent},\( {cells[4].textContent}, \){cells[5].textContent},"${cells[6].textContent}"\n`;
                }
            });
            const blob = new Blob(['\uFEFF' + csv], {type: 'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Rekap_Bermalam_${bulanRekap.selectedOptions[0].text}.csv`;
            a.click();
        }

        // Search
        searchInput.addEventListener('input', () => {
            const filter = searchInput.value.toLowerCase();
            document.querySelectorAll('#tabelLaporan tbody tr').forEach(row => {
                row.style.display = row.textContent.toLowerCase().includes(filter) ? '' : 'none';
            });
        });
    </script>
</body>
</html>
