<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rekap Karyawan Bermalam</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f6f9; padding: 20px; max-width: 1200px; margin: auto; }
        h1 { text-align: center; color: #333; }
        .tabs { overflow: hidden; border-bottom: 2px solid #007bff; margin-bottom: 30px; }
        .tablink { background: #f1f1f1; float: left; border: none; outline: none; cursor: pointer; padding: 14px 20px; font-size: 17px; width: 50%; }
        .tablink:hover { background: #ddd; }
        .tablink.active { background: #007bff; color: white; }
        .tabcontent { display: none; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        form { padding: 25px; margin-bottom: 30px; background: #f9f9f9; border-radius: 8px; }
        label { display: block; margin: 15px 0 5px; font-weight: bold; color: #444; }
        input, select { padding: 12px; width: 100%; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; box-sizing: border-box; }
        button { background: #28a745; color: white; padding: 12px 20px; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; }
        button:hover { background: #218838; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; vertical-align: top; }
        th { background: #007bff; color: white; }
        tr:hover { background: #f8f9fa; }
        .search-input { margin: 15px 0; padding: 10px; width: 100%; }
        .export-btn { background: #ffc107; color: #333; margin: 20px 0; padding: 12px; width: 100%; font-size: 16px; }
        .export-btn:hover { background: #e0a800; }
        .total-summary { font-weight: bold; font-size: 1.3em; text-align: right; margin: 30px 0; background: #e9ecef; padding: 20px; border-radius: 8px; }
        .filter-select { padding: 12px; margin-bottom: 20px; width: 100%; font-size: 16px; }
        #alasanContainer { display: none; margin-top: 15px; }
        .multi-row { background: #f0f8ff; }
    </style>
</head>
<body>
    <h1>Rekap Karyawan Bermalam</h1>

    <div class="tabs">
        <button class="tablink active" onclick="openTab(event, 'Input')">Input Laporan</button>
        <button class="tablink" onclick="openTab(event, 'Rekap')">Rekap Bulanan</button>
    </div>

    <div id="Input" class="tabcontent" style="display: block;">
        <form id="laporanForm">
            <label>Nama Karyawan</label>
            <input type="text" id="nama" required placeholder="Masukkan nama karyawan">

            <label>Cabang Diinapi</label>
            <select id="cabang" required>
                <option value="Twincom Banjarbaru">Twincom Banjarbaru</option>
                <option value="Twincom Martapura">Twincom Martapura</option>
                <option value="Twincom A. Yani">Twincom A. Yani</option>
                <option value="Pandacom Banjarbaru">Pandacom Banjarbaru</option>
            </select>

            <label>Tanggal Bermalam</label>
            <input type="date" id="tanggal" required>

            <label>Jam Datang</label>
            <input type="time" id="jamDatang" required>

            <div id="alasanContainer">
                <label>Alasan Telat (wajib jika > 22:30)</label>
                <input type="text" id="alasanTelat" placeholder="Tuliskan alasan keterlambatan">
            </div>

            <button type="submit">Tambah Laporan</button>
        </form>

        <h2>Daftar Laporan Terbaru</h2>
        <input type="text" id="searchInput" class="search-input" placeholder="Cari nama, cabang, atau alasan...">
        <table id="tabelLaporan">
            <thead>
                <tr>
                    <th>No</th>
                    <th>Waktu Input</th>
                    <th>Tanggal</th>
                    <th>Jam Datang</th>
                    <th>Nama</th>
                    <th>Cabang</th>
                    <th>Alasan Telat</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="Rekap" class="tabcontent">
        <h2>Rekap Karyawan Bermalam Bulanan</h2>
        <select id="bulanRekap" class="filter-select" onchange="updateRekap()"></select>

        <table id="tabelRekap">
            <thead>
                <tr>
                    <th>NO</th>
                    <th>NAMA KARYAWAN</th>
                    <th>TANGGAL BERMALAM</th>
                    <th>CABANG DIINAPI</th>
                    <th>TOTAL BERMALAM</th>
                    <th>JUMLAH UANG BERMALAM</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div class="total-summary" id="totalSummary"></div>
        <button class="export-btn" onclick="exportRekapCSV()">Export Rekap ke CSV (Excel)</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // GANTI DENGAN CONFIG FIREBASE ANDA
const firebaseConfig = {
  apiKey: "AIzaSyBthcmgxb-S7AOqhQEkRl4gA2tGtc373DE",
  authDomain: "laporan-bermalam.firebaseapp.com",
  databaseURL: "https://laporan-bermalam-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "laporan-bermalam",
  storageBucket: "laporan-bermalam.firebasestorage.app",
  messagingSenderId: "999268337318",
  appId: "1:999268337318:web:ca06ca521b49347bce9667",
  measurementId: "G-NPZ94WSPXX"
};

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const refLaporan = db.ref('laporan');

        const form = document.getElementById('laporanForm');
        const jamDatang = document.getElementById('jamDatang');
        const alasanContainer = document.getElementById('alasanContainer');
        const alasanTelat = document.getElementById('alasanTelat');
        const tabelBody = document.querySelector('#tabelLaporan tbody');
        const rekapBody = document.querySelector('#tabelRekap tbody');
        const bulanRekap = document.getElementById('bulanRekap');
        const totalSummary = document.getElementById('totalSummary');
        const searchInput = document.getElementById('searchInput');
        let allData = [];

        document.getElementById('tanggal').valueAsDate = new Date();

        jamDatang.addEventListener('change', () => {
            if (jamDatang.value > '22:30') {
                alasanContainer.style.display = 'block';
                alasanTelat.required = true;
            } else {
                alasanContainer.style.display = 'none';
                alasanTelat.required = false;
                alasanTelat.value = '';
            }
        });

        function openTab(evt, tabName) {
            document.querySelectorAll('.tabcontent').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.tablink').forEach(el => el.classList.remove('active'));
            document.getElementById(tabName).style.display = 'block';
            evt.currentTarget.classList.add('active');
            if (tabName === 'Rekap') updateRekap();
        }

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const nama = document.getElementById('nama').value.trim().toUpperCase();
            const cabang = document.getElementById('cabang').value;
            const tanggal = document.getElementById('tanggal').value;
            const jam = jamDatang.value;
            const alasan = jam > '22:30' ? alasanTelat.value.trim() : '';

            if (!nama || !cabang || !tanggal || !jam) {
                alert('Semua field wajib diisi!');
                return;
            }
            if (jam > '22:30' && !alasan) {
                alert('Alasan telat wajib diisi!');
                return;
            }

            refLaporan.push({
                nama,
                cabang,
                tanggal,
                jamDatang: jam,
                alasanTelat: alasan,
                timestamp: Date.now()
            });

            alert('Laporan berhasil ditambahkan!');
            form.reset();
            document.getElementById('tanggal').valueAsDate = new Date();
            alasanContainer.style.display = 'none';
        });

        refLaporan.on('value', (snapshot) => {
            allData = [];
            const data = snapshot.val();
            if (data) Object.values(data).forEach(val => allData.push(val));
            renderLaporan();
            updateBulanFilter(); // Diperbaiki agar opsi bulan selalu muncul
            if (document.getElementById('Rekap').style.display === 'block') updateRekap();
        });

        function renderLaporan() {
            tabelBody.innerHTML = allData.length === 0 ? '<tr><td colspan="7" style="text-align:center; color:#666;">Belum ada laporan</td></tr>' : '';
            allData.sort((a, b) => b.timestamp - a.timestamp).forEach((val, i) => {
                const waktu = new Date(val.timestamp).toLocaleString('id-ID');
                tabelBody.innerHTML += `<tr>
                    <td>${i + 1}</td>
                    <td>${waktu}</td>
                    <td>${val.tanggal}</td>
                    <td>${val.jamDatang}</td>
                    <td>${val.nama}</td>
                    <td>${val.cabang}</td>
                    <td>${val.alasanTelat || '-'}</td>
                </tr>`;
            });
        }

        // Perbaikan utama: Dropdown bulan sekarang pasti terisi
        function updateBulanFilter() {
            const bulanMap = {};
            allData.forEach(d => {
                const date = new Date(d.tanggal);
                const year = date.getFullYear();
                const month = date.getMonth();
                const key = `\( {year}- \){month}`;
                if (!bulanMap[key]) {
                    bulanMap[key] = new Date(year, month).toLocaleString('id-ID', { month: 'long', year: 'numeric' });
                }
            });

            bulanRekap.innerHTML = '<option value="">Pilih Bulan Rekap</option>';
            Object.keys(bulanMap).sort((a, b) => b.localeCompare(a)).forEach(key => {
                bulanRekap.innerHTML += `<option value="\( {key}"> \){bulanMap[key]}</option>`;
            });

            // Auto select bulan terbaru jika ada data
            if (Object.keys(bulanMap).length > 0) {
                bulanRekap.value = Object.keys(bulanMap).sort((a, b) => b.localeCompare(a))[0];
                updateRekap(); // Auto update rekap saat tab dibuka
            }
        }

        // Rekap dan export tetap sama (sudah benar)
        function updateRekap() {
            // ... (kode rekap sama seperti versi sebelumnya yang sudah benar, dengan createElement untuk rowspan)
            // Untuk singkat, gunakan kode rekap dari versi sebelumnya yang menggunakan createElement untuk menghindari error rowspan
            // (sama seperti respons sebelumnya)
        }

        // Export dan search sama

    </script>
</body>
</html>
